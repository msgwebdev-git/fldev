# –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã –±–∏–ª–µ—Ç–æ–≤ Festivalul Lupilor

> **–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 7 –¥–µ–∫–∞–±—Ä—è 2024
> **–¶–µ–ª—å:** –ü–æ–ª–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã –±–∏–ª–µ—Ç–æ–≤ –ø–µ—Ä–µ–¥ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–æ–π B2B —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

---

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#1-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã)
2. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#2-–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
3. [–ü—Ä–æ—Ü–µ—Å—Å –ø–æ–∫—É–ø–∫–∏ –±–∏–ª–µ—Ç–æ–≤](#3-–ø—Ä–æ—Ü–µ—Å—Å-–ø–æ–∫—É–ø–∫–∏-–±–∏–ª–µ—Ç–æ–≤)
4. [–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞](#4-–ø–ª–∞—Ç–µ–∂–Ω–∞—è-—Å–∏—Å—Ç–µ–º–∞)
5. [–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –±–∏–ª–µ—Ç–æ–≤](#5-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è-–∏-–æ—Ç–ø—Ä–∞–≤–∫–∞-–±–∏–ª–µ—Ç–æ–≤)
6. [–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å](#6-–∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å)
7. [API Endpoints](#7-api-endpoints)
8. [Email —Å–∏—Å—Ç–µ–º–∞](#8-email-—Å–∏—Å—Ç–µ–º–∞)
9. [–í—ã–≤–æ–¥—ã –¥–ª—è B2B](#9-–≤—ã–≤–æ–¥—ã-–¥–ª—è-b2b)

---

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### 1.1 –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

**Frontend:**
- Next.js 16.0.6 (App Router + Turbopack)
- React 19 (latest)
- TypeScript
- Tailwind CSS + Shadcn UI
- i18n (—Ä—É–º—ã–Ω—Å–∫–∏–π, —Ä—É—Å—Å–∫–∏–π)
- React Context API (–¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã)

**Backend:**
- Node.js + Express.js
- TypeScript
- Supabase (PostgreSQL + Storage + Auth)
- Resend (Email —Å–µ—Ä–≤–∏—Å)
- PDFKit (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è PDF)
- QRCode (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–æ–≤)

**–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:**
- MAIB (Moldova Agroindbank) - –æ—Å–Ω–æ–≤–Ω–∞—è –ø–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ú–æ–ª–¥–æ–≤—ã
- Mock —Ä–µ–∂–∏–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- Supabase Storage (–æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –±–∏–ª–µ—Ç–æ–≤)
- Cron jobs (–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è)

### 1.2 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
fl-site/
‚îú‚îÄ‚îÄ src/                          # Frontend (Next.js)
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [locale]/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tickets/          # –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–±–æ—Ä–∞ –±–∏–ª–µ—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ checkout/         # –ü—Ä–æ—Ü–µ—Å—Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ b2b/              # B2B —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (NEW)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin/                # –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/                  # Next.js API routes
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ context/CartContext.tsx   # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω–æ–π
‚îÇ   ‚îú‚îÄ‚îÄ lib/api.ts                # API –∫–ª–∏–µ–Ω—Ç
‚îÇ
‚îú‚îÄ‚îÄ server/                       # Backend (Express)
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ checkout.ts       # API –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ webhook.ts        # Callbacks –æ—Ç MAIB
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin.ts          # Admin API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ order.ts          # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payment.ts        # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è MAIB
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ticket.ts         # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∏–ª–µ—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ticket-pdfkit.ts  # PDF –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ email.ts          # Email —Å–µ—Ä–≤–∏—Å
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ promo.ts          # –ü—Ä–æ–º–æ–∫–æ–¥—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cron.ts           # –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
‚îÇ
‚îú‚îÄ‚îÄ supabase/
‚îÇ   ‚îú‚îÄ‚îÄ migrations/               # SQL –º–∏–≥—Ä–∞—Ü–∏–∏
‚îÇ
‚îú‚îÄ‚îÄ messages/                     # i18n –ø–µ—Ä–µ–≤–æ–¥—ã
‚îÇ   ‚îú‚îÄ‚îÄ ro.json
‚îÇ   ‚îú‚îÄ‚îÄ ru.json
```

---

## 2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### 2.1 –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

#### `tickets` - –¢–∏–ø—ã –±–∏–ª–µ—Ç–æ–≤
```sql
CREATE TABLE tickets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL UNIQUE,
  name_ro TEXT NOT NULL,
  name_ru TEXT NOT NULL,
  description_ro TEXT,
  description_ru TEXT,
  features_ro TEXT[] DEFAULT '{}',
  features_ru TEXT[] DEFAULT '{}',
  price NUMERIC(10,2) NOT NULL,
  original_price NUMERIC(10,2),
  currency TEXT DEFAULT 'MDL',
  is_active BOOLEAN DEFAULT true,
  sort_order INTEGER DEFAULT 0,
  max_per_order INTEGER DEFAULT 10,
  has_options BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**–ü—Ä–∏–º–µ—Ä—ã –±–∏–ª–µ—Ç–æ–≤:**
- Day Pass - 380 MDL
- Weekend Pass - 600 MDL
- Camping Pass - 750 MDL (—Å –æ–ø—Ü–∏—è–º–∏)
- Family Passes - 900-1900 MDL

---

#### `ticket_options` - –û–ø—Ü–∏–∏ –±–∏–ª–µ—Ç–æ–≤
```sql
CREATE TABLE ticket_options (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  ticket_id UUID REFERENCES tickets(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  name_ro TEXT NOT NULL,
  name_ru TEXT NOT NULL,
  description_ro TEXT,
  description_ru TEXT,
  price_modifier NUMERIC(10,2) DEFAULT 0,
  is_default BOOLEAN DEFAULT false,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW()
);
```

**–ü—Ä–∏–º–µ—Ä—ã –æ–ø—Ü–∏–π (–¥–ª—è Camping Pass):**
- Tent Spot - 0 MDL (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- Parking Spot - 0 MDL
- Camper/RV Spot - 0 MDL

---

#### `orders` - –ó–∞–∫–∞–∑—ã
```sql
CREATE TABLE orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_number TEXT UNIQUE NOT NULL,           -- FL2512-XXXXXX
  status TEXT CHECK (status IN (
    'pending', 'paid', 'failed', 'refunded', 'expired', 'cancelled'
  )),
  customer_email TEXT NOT NULL,
  customer_name TEXT NOT NULL,
  customer_phone TEXT NOT NULL,
  total_amount NUMERIC(10,2) NOT NULL,
  discount_amount NUMERIC(10,2) DEFAULT 0,
  promo_code TEXT,
  maib_transaction_id TEXT,
  payment_status TEXT CHECK (payment_status IN (
    'pending', 'ok', 'failed', 'reversed'
  )),
  failure_reason TEXT,
  paid_at TIMESTAMP,
  reminder_sent_at TIMESTAMP,
  reminder_count INTEGER DEFAULT 0,
  language TEXT DEFAULT 'ro' CHECK (language IN ('ro', 'ru')),
  client_ip TEXT,
  is_invitation BOOLEAN DEFAULT false,
  refund_reason TEXT,
  refunded_at TIMESTAMP,
  refunded_by TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_orders_status` (–±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ —Å—Ç–∞—Ç—É—Å—É)
- `idx_orders_customer_email` (–ø–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞)
- `idx_orders_maib_transaction_id` (—Å–≤—è–∑—å —Å –ø–ª–∞—Ç–µ–∂–æ–º)
- `idx_orders_created_at` (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞)
- `idx_orders_is_invitation` (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π)

---

#### `order_items` - –ë–∏–ª–µ—Ç—ã –≤ –∑–∞–∫–∞–∑–µ
```sql
CREATE TABLE order_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID REFERENCES orders(id) ON DELETE CASCADE NOT NULL,
  ticket_id UUID REFERENCES tickets(id) NOT NULL,
  ticket_option_id UUID REFERENCES ticket_options(id),
  quantity INTEGER DEFAULT 1,
  unit_price NUMERIC(10,2) NOT NULL,
  ticket_code TEXT UNIQUE NOT NULL,              -- 12-—Å–∏–º–≤–æ–ª—å–Ω—ã–π –∫–æ–¥
  qr_data TEXT NOT NULL,                         -- JSON {code, ts, inv?}
  pdf_url TEXT,                                  -- –°—Å—ã–ª–∫–∞ –Ω–∞ Supabase Storage
  status TEXT DEFAULT 'valid' CHECK (status IN (
    'valid', 'used', 'refunded'
  )),
  scanned_at TIMESTAMP,
  is_invitation BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW()
);
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_order_items_order_id` (—Å–≤—è–∑—å —Å –∑–∞–∫–∞–∑–æ–º)
- `idx_order_items_ticket_code` (–±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É)
- `idx_order_items_status` (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è)
- `idx_order_items_is_invitation` (–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è)

**–í–∞–∂–Ω–æ:** –û–¥–∏–Ω –±–∏–ª–µ—Ç = –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å, –¥–∞–∂–µ –µ—Å–ª–∏ quantity > 1 –≤ –∫–æ—Ä–∑–∏–Ω–µ

---

#### `promo_codes` - –ü—Ä–æ–º–æ–∫–æ–¥—ã
```sql
CREATE TABLE promo_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code TEXT UNIQUE NOT NULL,
  discount_percent NUMERIC(5,2) CHECK (discount_percent BETWEEN 0 AND 100),
  discount_amount NUMERIC(10,2) CHECK (discount_amount >= 0),
  usage_limit INTEGER,
  used_count INTEGER DEFAULT 0,
  valid_from TIMESTAMP,
  valid_until TIMESTAMP,
  is_active BOOLEAN DEFAULT true,
  min_order_amount NUMERIC(10,2),
  allowed_ticket_ids UUID[],                     -- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –±–∏–ª–µ—Ç–∞–º
  one_per_email BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW()
);
```

**–ü—Ä–∏–º–µ—Ä—ã:**
- `WOLF10` - 10% —Å–∫–∏–¥–∫–∞ (–ª–∏–º–∏—Ç 100)
- `FESTIVAL20` - 20% —Å–∫–∏–¥–∫–∞ (–ª–∏–º–∏—Ç 50)
- `VIP50` - 50% —Å–∫–∏–¥–∫–∞ (–ª–∏–º–∏—Ç 10)

---

#### `email_logs` - –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ email
```sql
CREATE TABLE email_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID REFERENCES orders(id) ON DELETE SET NULL,
  email_type TEXT CHECK (email_type IN (
    'confirmation', 'reminder', 'refund'
  )),
  recipient TEXT NOT NULL,
  status TEXT DEFAULT 'sent' CHECK (status IN (
    'sent', 'failed', 'bounced'
  )),
  error_message TEXT,
  sent_at TIMESTAMP DEFAULT NOW()
);
```

---

### 2.2 TypeScript –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

```typescript
// –ë–∏–ª–µ—Ç
interface TicketData {
  id: string;
  name: string;
  nameRo: string;
  nameRu: string;
  descriptionRo?: string;
  descriptionRu?: string;
  featuresRo?: string[];
  featuresRu?: string[];
  price: number;
  originalPrice?: number;
  currency?: string;
  maxPerOrder?: number;
  hasOptions?: boolean;
  options?: TicketOption[];
}

// –û–ø—Ü–∏—è –±–∏–ª–µ—Ç–∞
interface TicketOption {
  id: string;
  name: string;
  nameRo: string;
  nameRu: string;
  descriptionRo?: string;
  descriptionRu?: string;
  priceModifier?: number;
  isDefault?: boolean;
}

// –≠–ª–µ–º–µ–Ω—Ç –∫–æ—Ä–∑–∏–Ω—ã
interface CartItem {
  ticket: TicketData;
  quantity: number;
  selectedOption?: TicketOption;
}
```

---

### 2.3 –°–≤—è–∑–∏ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏

```
tickets (1) ‚îÄ‚îÄ‚î¨‚îÄ‚Üí (M) ticket_options
              ‚îî‚îÄ‚Üí (M) order_items

orders (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí (M) order_items
           ‚îî‚îÄ‚îÄ‚îÄ‚Üí (M) email_logs

order_items ‚îÄ‚îÄ‚î¨‚îÄ‚Üí (1) tickets
              ‚îú‚îÄ‚Üí (1) ticket_options
              ‚îî‚îÄ‚Üí (1) orders (CASCADE DELETE)

promo_codes ‚îÄ‚îÄ‚Üí orders.promo_code (TEXT)
```

---

## 3. –ü—Ä–æ—Ü–µ—Å—Å –ø–æ–∫—É–ø–∫–∏ –±–∏–ª–µ—Ç–æ–≤

### 3.1 –ü–æ—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```
1. –í–´–ë–û–† –ë–ò–õ–ï–¢–û–í (/tickets)
   ‚Üì
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–∏–ø –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
   - –ï—Å–ª–∏ Camping Pass ‚Üí –≤—ã–±–æ—Ä –æ–ø—Ü–∏–∏ (–ø–∞–ª–∞—Ç–∫–∞/–ø–∞—Ä–∫–æ–≤–∫–∞/–∫–µ–º–ø–µ—Ä)
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É (CartContext)
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage (–∫–ª—é—á: "fl-cart")

2. –ü–ï–†–ï–•–û–î –ö CHECKOUT (/checkout)
   ‚Üì
   - –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã –∏–∑ localStorage
   - –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Üí redirect –Ω–∞ /tickets
   - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã + summary

3. –í–í–û–î –î–ê–ù–ù–´–•
   ‚Üì
   - firstName, lastName (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
   - email (–≤–∞–ª–∏–¥–∞—Ü–∏—è regex)
   - phone (–≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ react-phone-number-input)
   - hearAbout (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - comment (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - acceptTerms (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
   - acceptMarketing (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

4. –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ü–†–û–ú–û–ö–û–î–ê (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   ‚Üì
   - –í–≤–æ–¥ –∫–æ–¥–∞ (–º–∞—Å–∫–∞ UPPERCASE)
   - POST /api/promo/validate
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
   - –†–∞—Å—á—ë—Ç —Å–∫–∏–¥–∫–∏
   - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ summary

5. –°–û–ó–î–ê–ù–ò–ï –ó–ê–ö–ê–ó–ê
   ‚Üì
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
   - POST /api/checkout/create-order
   - Backend —Å–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑ (status: pending)
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ticket_code –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∏–ª–µ—Ç–∞
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–¥–∞–Ω–Ω—ã—Ö

6. –ü–õ–ê–¢–Å–ñ
   ‚Üì
   - Backend —Å–æ–∑–¥–∞—ë—Ç MAIB —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
   - Redirect –Ω–∞ MAIB Gateway (–∏–ª–∏ mock-payment)
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
   - MAIB –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç callback –Ω–∞ /api/webhook/maib

7. –û–ë–†–ê–ë–û–¢–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–ê
   ‚Üì
   A. –£–°–ü–ï–• (OK):
      - –°—Ç–∞—Ç—É—Å: paid
      - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –±–∏–ª–µ—Ç–æ–≤ (async)
      - –û—Ç–ø—Ä–∞–≤–∫–∞ email —Å –±–∏–ª–µ—Ç–∞–º–∏
      - Redirect ‚Üí /checkout/success

   B. –û–®–ò–ë–ö–ê (FAILED):
      - –°—Ç–∞—Ç—É—Å: failed
      - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã
      - Redirect ‚Üí /checkout/failed

   C. –û–ñ–ò–î–ê–ù–ò–ï (PENDING):
      - –û—Å—Ç–∞—ë—Ç—Å—è pending
      - –ß–µ—Ä–µ–∑ 1 —á–∞—Å ‚Üí –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ #1
      - –ß–µ—Ä–µ–∑ 24 —á–∞—Å–∞ ‚Üí –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ #2
      - –ß–µ—Ä–µ–∑ 72 —á–∞—Å–∞ ‚Üí —Å—Ç–∞—Ç—É—Å expired

8. –°–¢–†–ê–ù–ò–¶–ê –£–°–ü–ï–•–ê (/checkout/success)
   ‚Üì
   - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞
   - Polling –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ PDF)
   - –ö–Ω–æ–ø–∫–∞ "–°–∫–∞—á–∞—Ç—å –±–∏–ª–µ—Ç—ã" (–∞–∫—Ç–∏–≤–Ω–∞ –∫–æ–≥–¥–∞ PDF –≥–æ—Ç–æ–≤—ã)
   - GET /api/checkout/tickets/{orderNumber}/download
```

### 3.2 –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (Backend)

**Endpoint:** `POST /api/checkout/create-order`

**Request:**
```typescript
{
  customer: {
    firstName: string,
    lastName: string,
    email: string,
    phone: string
  },
  items: [
    {
      ticketId: string,
      optionId?: string,
      quantity: number
    }
  ],
  promoCode?: string,
  language: 'ro' | 'ru'
}
```

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –û—Ç–º–µ–Ω–∞ —Å—Ç–∞—Ä—ã—Ö pending –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ email
2. –†–∞—Å—á—ë—Ç —Ü–µ–Ω—ã:
   - –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –±–∏–ª–µ—Ç–∞
   - + –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –æ–ø—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - √ó –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
4. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞:
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è order_number: `FL${YYMM}-${nanoid(6)}`
   - status: `pending`
   - payment_status: `pending`
5. –°–æ–∑–¥–∞–Ω–∏–µ order_items:
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∏–ª–µ—Ç–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è ticket_code (12 —Å–∏–º–≤–æ–ª–æ–≤)
   - QR –¥–∞–Ω–Ω—ã–µ: `{code, ts: Date.now()}`
6. –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç used_count –ø—Ä–æ–º–æ–∫–æ–¥–∞
7. –°–æ–∑–¥–∞–Ω–∏–µ MAIB —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
8. –í–æ–∑–≤—Ä–∞—Ç `{orderId, orderNumber, redirectUrl}`

---

## 4. –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

### 4.1 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è MAIB

**MAIB** - Moldova Agroindbank, –æ—Å–Ω–æ–≤–Ω–∞—è –ø–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ú–æ–ª–¥–æ–≤—ã

**–†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã:**
- **Production** - —Ä–µ–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ MAIB Gateway
- **Mock** - —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

**–§–∞–π–ª:** `/Users/aleksandrkorcevoj/fl-site/server/src/services/payment.ts`

### 4.2 –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

```typescript
interface CreateTransactionParams {
  orderId: string;
  amount: number;
  description: string;
  clientIp: string;
  language: 'ro' | 'ru';
  customerName?: string;
  customerEmail?: string;
  customerPhone?: string;
}

// Mock —Ä–µ–∂–∏–º
if (config.maib.mockMode) {
  const mockTransactionId = `MOCK_${nanoid(20)}`;
  return {
    transactionId: mockTransactionId,
    payUrl: `/checkout/mock-payment?trans_id=${mockTransactionId}`
  };
}

// Production —Ä–µ–∂–∏–º
const payment = await maibClient.createPayment({
  amount: params.amount,
  currency: 'MDL',
  clientIp: params.clientIp,
  orderId: params.orderId,
  description: params.description,
  okUrl: `${frontendUrl}/checkout/success?order=${params.orderId}`,
  failUrl: `${frontendUrl}/checkout/failed?order=${params.orderId}`,
  callbackUrl: `${backendUrl}/api/webhook/maib`
});

return {
  transactionId: payment.payId,
  payUrl: payment.payUrl
};
```

### 4.3 Callback –æ–±—Ä–∞–±–æ—Ç–∫–∞

**Endpoint:** `POST /api/webhook/maib`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ MAIB
2. –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞ –ø–æ transactionId
3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
   - `OK/COMPLETED/SUCCESS/APPROVED` ‚Üí markAsPaid()
   - `FAILED/DECLINED/ERROR` ‚Üí markAsFailed()
   - `PENDING` ‚Üí –æ—Å—Ç–∞–≤–∏—Ç—å pending
4. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∏–ª–µ—Ç–æ–≤ (–¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö)

---

## 5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –±–∏–ª–µ—Ç–æ–≤

### 5.1 –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF

**–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞:** PDFKit (–±—ã—Å—Ç—Ä–µ–µ —á–µ–º @react-pdf)

**–§–∞–π–ª:** `/Users/aleksandrkorcevoj/fl-site/server/src/services/ticket-pdfkit.ts`

**–†–∞–∑–º–µ—Ä—ã –±–∏–ª–µ—Ç–∞:**
- –®–∏—Ä–∏–Ω–∞: 320 –ø—Ç (~11 —Å–º)
- –í—ã—Å–æ—Ç–∞: 560 –ø—Ç (~20 —Å–º)

**–≠–ª–µ–º–µ–Ω—Ç—ã –±–∏–ª–µ—Ç–∞:**
1. –§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (`/server/src/assets/ticket-bg.jpg`)
2. –ë–µ–ª–∞—è —Å–µ–∫—Ü–∏—è —Å rounded corners
3. –ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–µ—Å—Ç–∏–≤–∞–ª—è: "FESTIVALUL LUPILOR" (14pt, –∂–∏—Ä–Ω—ã–π)
4. –î–∞—Ç–∞: "7-9 August 2026" (10pt, —Å–µ—Ä—ã–π)
5. **QR-–∫–æ–¥**: 120x120 –ø—Ç
6. **–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥**: 12 —Å–∏–º–≤–æ–ª–æ–≤ (Courier)
7. –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å (–ª–∏–Ω–∏—è)
8. **–¢–∏–ø –±–∏–ª–µ—Ç–∞**: –Ω–∞–∑–≤–∞–Ω–∏–µ (16pt, –∂–∏—Ä–Ω—ã–π)
9. **–û–ø—Ü–∏—è**: –µ—Å–ª–∏ –µ—Å—Ç—å (11pt)
10. **–ò–º—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è**: (10pt)
11. **–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞**: #FL2512-XXXXXX

**–î–≤–∞ —Ç–∏–ø–∞ –±–∏–ª–µ—Ç–æ–≤:**
- `createTicketPDF` - –æ–±—ã—á–Ω—ã–π –±–∏–ª–µ—Ç
- `createInvitationPDF` - –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ (–∑–æ–ª–æ—Ç–æ–π –∑–Ω–∞—á–æ–∫ "INVITATION")

### 5.2 QR-–∫–æ–¥—ã

**–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞:** `qrcode`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```typescript
{
  width: 300,
  margin: 2,
  color: {
    dark: '#000000',
    light: '#ffffff'
  },
  errorCorrectionLevel: 'L'
}
```

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ QR:**
```json
{
  "code": "TICKET_CODE_12",
  "ts": 1733520000,
  "inv": true  // —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
}
```

**–§–æ—Ä–º–∞—Ç:** Base64 data URL (PNG), –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ PDF

### 5.3 –•—Ä–∞–Ω–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤

**–•—Ä–∞–Ω–∏–ª–∏—â–µ:** Supabase Storage

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
tickets/
  FL2512-XXXXXX/
    ‚îú‚îÄ‚îÄ TICKET_CODE_1.pdf
    ‚îú‚îÄ‚îÄ TICKET_CODE_2.pdf
    ‚îî‚îÄ‚îÄ ...
```

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. PDF –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ (Buffer)
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ Supabase Storage
3. –ü–æ–ª—É—á–∞–µ—Ç—Å—è –ø—É–±–ª–∏—á–Ω—ã–π URL
4. URL —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `order_items.pdf_url`

**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:** –í—Å–µ –±–∏–ª–µ—Ç—ã –∑–∞–∫–∞–∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (`Promise.all()`)

### 5.4 Email –æ—Ç–ø—Ä–∞–≤–∫–∞

**–°–µ—Ä–≤–∏—Å:** Resend API

**–§–∞–π–ª:** `/Users/aleksandrkorcevoj/fl-site/server/src/services/email.ts`

**–¢–∏–ø—ã –ø–∏—Å–µ–º:**

#### 1. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (`sendOrderConfirmation`)
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∏–º–µ–Ω–µ–º
- –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ #FL2512-XXXXXX
- –†–µ–∑—é–º–µ –∑–∞–∫–∞–∑–∞ (—Å—É–º–º–∞, —Å–∫–∏–¥–∫–∞)
- –¢–∞–±–ª–∏—Ü–∞ –±–∏–ª–µ—Ç–æ–≤ —Å –∫–æ–¥–∞–º–∏
- –ö–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è PDF:
  - 1-2 –±–∏–ª–µ—Ç–∞ ‚Üí –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
  - 3+ –±–∏–ª–µ—Ç–æ–≤ ‚Üí –æ–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–°–∫–∞—á–∞—Ç—å –≤—Å–µ" (ZIP)
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (–∂—ë–ª—Ç–æ–µ): "–°–æ—Ö—Ä–∞–Ω–∏ –±–∏–ª–µ—Ç—ã..."
- –ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–∏–∫–æ–Ω–∫–∏)
- –°–µ–∫—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (App Store, Google Play)

#### 2. –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ (`sendInvitationEmail`)
- –ó–æ–ª–æ—Ç–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
- –ó–Ω–∞—á–æ–∫ "INVITATION"
- –ë–µ–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ü–µ–Ω–µ

#### 3. –ü–µ—Ä–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (1 —á–∞—Å)
- –û—Ä–∞–Ω–∂–µ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
- "–ó–∞–±—ã–ª–∏ –æ–ø–ª–∞—Ç–∏—Ç—å?"
- –ú—è–≥–∫–∏–π —Ç–æ–Ω
- –°—É–º–º–∞ –∑–∞–∫–∞–∑–∞

#### 4. –í—Ç–æ—Ä–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (24 —á–∞—Å–∞)
- –ö—Ä–∞—Å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
- "–ë–∏–ª–µ—Ç—ã –µ—â—ë –∂–¥—É—Ç!"
- –°—Ä–æ—á–Ω—ã–π —Ç–æ–Ω

**–Ø–∑—ã–∫–∏:** RO –∏ RU (–ø–µ—Ä–µ–≤–æ–¥—ã –≤ —Å–∞–º–æ–º —Ñ–∞–π–ª–µ)

---

## 6. –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å

### 6.1 –°—Ç—Ä—É–∫—Ç—É—Ä–∞

**–ü—É—Ç—å:** `/src/app/admin`

**–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** Supabase Auth (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞)

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã:**
- **Dashboard** - –æ–±–∑–æ—Ä
- **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞** - –≥—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–æ–¥–∞–∂
- **–ó–∞–∫–∞–∑—ã** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏
- **–ë–∏–ª–µ—Ç—ã** - —Ç–∏–ø—ã –±–∏–ª–µ—Ç–æ–≤
- **–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è** - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –±–∏–ª–µ—Ç—ã
- **–ü—Ä–æ–º–æ-–∫–æ–¥—ã** - —Å–∫–∏–¥–∫–∏
- Lineup, –ü—Ä–æ–≥—Ä–∞–º–º–∞, –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –ù–æ–≤–æ—Å—Ç–∏, –ü–∞—Ä—Ç–Ω—ë—Ä—ã
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### 6.2 –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏

**–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤** (`/admin/orders`)

**–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:**
- –ü–æ —Å—Ç–∞—Ç—É—Å—É (pending, paid, failed, expired, cancelled, refunded)
- –ü–æ —Ç–∏–ø—É (–æ–±—ã—á–Ω—ã–µ / –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è)
- –ü–æ –ø–µ—Ä–∏–æ–¥—É (7–¥, 30–¥, 3–º, 1–≥, –≤—Å—ë –≤—Ä–µ–º—è, –∫–∞—Å—Ç–æ–º)
- –ü–æ–∏—Å–∫ (–Ω–æ–º–µ—Ä, email, –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω)

**–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:**
- –ü–æ –Ω–æ–º–µ—Ä—É, —Å—É–º–º–µ, –¥–∞—Ç–µ

**–§—É–Ω–∫—Ü–∏–∏:**
- –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
- –ü–∞–≥–∏–Ω–∞—Ü–∏—è (20 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ)

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
- –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤
- –û–ø–ª–∞—á–µ–Ω–æ
- –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã
- –û—Ç–º–µ–Ω–µ–Ω–æ/–æ—à–∏–±–∫–∏
- –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞
- –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π

**–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞** (`/admin/orders/[id]`)

**–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**
- –ù–æ–º–µ—Ä, —Å—Ç–∞—Ç—É—Å, –¥–∞—Ç–∞
- –°—É–º–º–∞, —Å–∫–∏–¥–∫–∞, –∏—Ç–æ–≥–æ
- –ö–æ–ª-–≤–æ –±–∏–ª–µ—Ç–æ–≤
- –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã
- –Ø–∑—ã–∫ –∫–ª–∏–µ–Ω—Ç–∞

**–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞:**
- –§–ò–û, email, —Ç–µ–ª–µ—Ñ–æ–Ω
- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤
- –û–±—â–∞—è —Å—É–º–º–∞ –ø–æ–∫—É–ø–æ–∫

**–î–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∞:**
- –°—Ç–∞—Ç—É—Å, –¥–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã
- –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞
- MAIB Transaction ID
- IP –∫–ª–∏–µ–Ω—Ç–∞
- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–¥–æ 2)

**–°–ø–∏—Å–æ–∫ –±–∏–ª–µ—Ç–æ–≤:**
- –ö–æ–¥ –∫–∞–∂–¥–æ–≥–æ –±–∏–ª–µ—Ç–∞
- –°—Ç–∞—Ç—É—Å (valid/used/refunded)
- –î–∞—Ç–∞ —Å–∫–∞–Ω–∞
- –¶–µ–Ω–∞

### 6.3 –û–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞–¥ –∑–∞–∫–∞–∑–∞–º–∏

#### –ò–∑–º–µ–Ω–µ–Ω–∏–µ email
**API:** `PATCH /api/admin/orders/[id]/update-email`
- –í–∞–ª–∏–¥–∞—Ü–∏—è email
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î

#### –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
**API:** `POST /api/admin/orders/[id]/refund`
- –¢–æ–ª—å–∫–æ –¥–ª—è paid –∑–∞–∫–∞–∑–æ–≤
- –¢—Ä–µ–±—É–µ—Ç –ø—Ä–∏—á–∏–Ω—É –≤–æ–∑–≤—Ä–∞—Ç–∞
- **–ù–µ–æ–±—Ä–∞—Ç–∏–º–æ!**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ: refund_reason, refunded_at, refunded_by

#### –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –±–∏–ª–µ—Ç–æ–≤
**API:** `POST /api/admin/orders/[id]/resend-tickets`
- –¢–æ–ª—å–∫–æ –¥–ª—è paid –∑–∞–∫–∞–∑–æ–≤
- –û—Ç–ø—Ä–∞–≤–∫–∞ email —Å PDF
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ: reminder_count, reminder_sent_at

#### –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤
- –û—Ç–∫—Ä—ã–≤–∞–µ—Ç GET /api/checkout/tickets/{orderNumber}/download
- 1 –±–∏–ª–µ—Ç ‚Üí PDF
- 2+ –±–∏–ª–µ—Ç–æ–≤ ‚Üí ZIP

### 6.4 –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

**–ú–µ—Ç—Ä–∏–∫–∏:**
- –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤ (–æ–ø–ª–∞—á–µ–Ω–æ)
- –í—ã—Ä—É—á–∫–∞ (MDL)
- –ë–∏–ª–µ—Ç–æ–≤ –ø—Ä–æ–¥–∞–Ω–æ
- –°—Ä–µ–¥–Ω–∏–π —á–µ–∫

**–ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–¥–∞–∂:**
- –ü–µ—Ä–∏–æ–¥—ã: 7–¥, 30–¥, 3–º, 1–≥, –≤—Å—ë –≤—Ä–µ–º—è
- –†–µ–∂–∏–º—ã: –≤—ã—Ä—É—á–∫–∞, –∑–∞–∫–∞–∑—ã, –±–∏–ª–µ—Ç—ã
- –¢–∏–ø—ã: –≥—Ä–∞—Ñ–∏–∫ –ø–ª–æ—â–∞–¥–∏, —Å—Ç–æ–ª–±—Ü—ã
- –ê–≥—Ä–µ–≥–∞—Ü–∏—è: –¥–Ω–∏/–Ω–µ–¥–µ–ª–∏/–º–µ—Å—è—Ü—ã

**–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –±–∏–ª–µ—Ç—ã:**
- –¢–æ–ø 10
- –ü–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∏–ª–∏ –≤—ã—Ä—É—á–∫–µ
- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –∏–ª–∏ –ø–∏—Ä–æ–≥
- –¢–∞–±–ª–∏—Ü–∞ —Å –¥–µ—Ç–∞–ª—è–º–∏

---

## 7. API Endpoints

### 7.1 Frontend API (Next.js)

```
POST   /api/admin/orders/[id]/update-email
POST   /api/admin/orders/[id]/resend-tickets
POST   /api/admin/orders/[id]/refund
```

### 7.2 Backend API (Express)

**Checkout:**
```
POST   /api/checkout/create-order
GET    /api/checkout/callback?trans_id=XXX
POST   /api/checkout/mock-process
GET    /api/checkout/status/:orderNumber
GET    /api/checkout/tickets/:orderNumber
GET    /api/checkout/tickets/:orderNumber/download
```

**Promo:**
```
POST   /api/promo/validate
```

**Webhook:**
```
POST   /api/webhook/maib
```

**Admin:**
```
POST   /api/admin/orders/:orderId/resend-tickets
POST   /api/admin/orders/:orderId/refund
POST   /api/admin/invitations
```

---

## 8. Email —Å–∏—Å—Ç–µ–º–∞

### 8.1 –°–µ—Ä–≤–∏—Å: Resend

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```typescript
const resend = new Resend(config.email.resendApiKey);
from: config.email.from // support@festivalullupilor.md
```

### 8.2 –®–∞–±–ª–æ–Ω—ã

**–í—Å–µ —à–∞–±–ª–æ–Ω—ã:**
- HTML —Å inline CSS
- Responsive –¥–∏–∑–∞–π–Ω
- –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç—å (RO/RU)
- –ë—Ä–µ–Ω–¥–∏–Ω–≥ —Ñ–µ—Å—Ç–∏–≤–∞–ª—è

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∏—Å—å–º–∞:**
- –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∏–º–µ–Ω–µ–º
- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
- CTA –∫–Ω–æ–ø–∫–∏
- Footer —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏

### 8.3 –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

**Cron jobs:**
- –ö–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç: –ø–µ—Ä–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (1 —á–∞—Å)
- –ö–∞–∂–¥—ã–π —á–∞—Å: –≤—Ç–æ—Ä–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (24 —á–∞—Å–∞)
- –ö–∞–∂–¥—ã–π —á–∞—Å: –∏—Å—Ç–µ—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ (72 —á–∞—Å–∞)

**–ö–æ–Ω—Ñ–∏–≥:**
```typescript
cron: {
  enabled: process.env.ENABLE_CRON_JOBS === 'true',
  firstReminderHours: 1,
  secondReminderHours: 24,
  pendingExpireHours: 72
}
```

---

## 9. –í—ã–≤–æ–¥—ã –¥–ª—è B2B

### 9.1 –ß—Ç–æ –º–æ–∂–µ–º –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

‚úÖ **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
- –¢–∞–±–ª–∏—Ü—ã `tickets`, `ticket_options` - –∫–∞–∫ –µ—Å—Ç—å
- –¢–∞–±–ª–∏—Ü–∞ `orders` - —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–ª—è B2B
- –¢–∞–±–ª–∏—Ü–∞ `order_items` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
- –¢–∞–±–ª–∏—Ü–∞ `email_logs` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

‚úÖ **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∏–ª–µ—Ç–æ–≤:**
- PDFKit –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä - –≥–æ—Ç–æ–≤
- QR-–∫–æ–¥—ã - –≥–æ—Ç–æ–≤—ã
- Supabase Storage - –≥–æ—Ç–æ–≤
- Email —Å–µ—Ä–≤–∏—Å - –≥–æ—Ç–æ–≤

‚úÖ **–ü–ª–∞—Ç—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:**
- MAIB –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è - –≥–æ—Ç–æ–≤–∞
- Callback –æ–±—Ä–∞–±–æ—Ç–∫–∞ - –≥–æ—Ç–æ–≤–∞
- Mock —Ä–µ–∂–∏–º - –≥–æ—Ç–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

‚úÖ **Admin —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è/–ø–æ–∏—Å–∫ - –≥–æ—Ç–æ–≤
- –≠–∫—Å–ø–æ—Ä—Ç CSV - –≥–æ—Ç–æ–≤
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - —á–∞—Å—Ç–∏—á–Ω–æ –≥–æ—Ç–æ–≤

### 9.2 –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å

‚ùå **–ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
```sql
-- B2B –∑–∞–∫–∞–∑—ã
b2b_orders:
  - id
  - order_number
  - company_name
  - company_tax_id
  - contact_name, contact_email, contact_phone
  - payment_method (enum: 'online', 'invoice')
  - status (pending, invoice_sent, paid, tickets_sent, completed, cancelled)
  - total_amount, discount_percent, discount_amount, final_amount
  - invoice_url
  - notes
  - created_at, updated_at

-- –ü–æ–∑–∏—Ü–∏–∏ B2B –∑–∞–∫–∞–∑–∞
b2b_order_items:
  - id
  - order_id (FK -> b2b_orders)
  - ticket_id (FK -> tickets)
  - quantity
  - unit_price
  - discount_percent
  - total_price

-- –ò—Å—Ç–æ—Ä–∏—è B2B –∑–∞–∫–∞–∑–æ–≤
b2b_order_history:
  - id
  - order_id
  - status
  - changed_by (admin user_id)
  - note
  - created_at
```

‚ùå **–ù–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–∞–∫–µ—Ç–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ
- –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–∫–∏–¥–æ–∫ (10-20%)
- –§–æ—Ä–º–∞ B2B –∑–∞–∫–∞–∑–∞
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—á–µ—Ç–æ–≤ (PDF)
- –ú–∞—Å—Å–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∏–ª–µ—Ç–æ–≤
- Admin –ø–∞–Ω–µ–ª—å B2B:
  - –°–ø–∏—Å–æ–∫ B2B –∑–∞–∫–∞–∑–æ–≤
  - –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
  - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—á–µ—Ç–æ–≤
  - –û—Ç–ø—Ä–∞–≤–∫–∞ –±–∏–ª–µ—Ç–æ–≤
  - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏

‚ùå **–ù–æ–≤—ã–µ API:**
```
POST   /api/b2b/calculate-discount
POST   /api/b2b/create-order
POST   /api/b2b/orders/:id/generate-invoice
POST   /api/b2b/orders/:id/generate-tickets
POST   /api/b2b/orders/:id/send-tickets
PATCH  /api/b2b/orders/:id/mark-paid
```

‚ùå **–ù–æ–≤—ã–µ email —à–∞–±–ª–æ–Ω—ã:**
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ B2B –∑–∞–∫–∞–∑–∞
- –°—á—ë—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É (PDF –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± –æ–ø–ª–∞—Ç–µ
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∏–ª–µ—Ç–æ–≤
- –û—Ç–ø—Ä–∞–≤–∫–∞ –±–∏–ª–µ—Ç–æ–≤ (ZIP –∞—Ä—Ö–∏–≤)

### 9.3 –ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è B2B

| –ê—Å–ø–µ–∫—Ç | B2C (—Ç–µ–∫—É—â–∞—è) | B2B (–ø–ª–∞–Ω–∏—Ä—É–µ–º–∞—è) |
|--------|--------------|------------------|
| **–ú–∏–Ω–∏–º—É–º –±–∏–ª–µ—Ç–æ–≤** | 1 | 50 |
| **–°–∫–∏–¥–∫–∞** | 0-50% (–ø—Ä–æ–º–æ–∫–æ–¥) | 10-20% (–ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è) |
| **–û–ø–ª–∞—Ç–∞** | –¢–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω | –û–Ω–ª–∞–π–Ω –∏–ª–∏ –ø–æ —Å—á—ë—Ç—É |
| **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∏–ª–µ—Ç–æ–≤** | –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã | –í—Ä—É—á–Ω—É—é –∏–ª–∏ –∞–≤—Ç–æ |
| **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è** | –ò–º—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è | –ò–º—è –∫–æ–º–ø–∞–Ω–∏–∏ + —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ |
| **Email** | 1 –∞–¥—Ä–µ—Å | –ù–µ—Å–∫–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å–æ–≤ |
| **–°—Ç–∞—Ç—É—Å—ã** | 6 —Å—Ç–∞—Ç—É—Å–æ–≤ | 6+ —Å—Ç–∞—Ç—É—Å–æ–≤ (invoice_sent, tickets_sent) |
| **–°—á–µ—Ç–∞** | –ù–µ—Ç | PDF —Å—á—ë—Ç |
| **–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å** | –ë–∞–∑–æ–≤–∞—è | –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –æ—Ç–ø—Ä–∞–≤–∫–∞) |

### 9.4 –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

‚úÖ **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (ticket.ts, ticket-pdfkit.ts)
- Email —Å–µ—Ä–≤–∏—Å (—Ä–∞—Å—à–∏—Ä–∏—Ç—å —à–∞–±–ª–æ–Ω–∞–º–∏)
- –ü–ª–∞—Ç—ë–∂–Ω—ã–π —Å–µ—Ä–≤–∏—Å (MAIB)
- –•—Ä–∞–Ω–∏–ª–∏—â–µ (Supabase Storage)

‚úÖ **–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ:**
- `b2b-order.ts` - —Å–µ—Ä–≤–∏—Å B2B –∑–∞–∫–∞–∑–æ–≤
- `invoice.ts` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—á–µ—Ç–æ–≤
- `b2b-discount.ts` - –ª–æ–≥–∏–∫–∞ —Å–∫–∏–¥–æ–∫
- `b2b-email.ts` - B2B —à–∞–±–ª–æ–Ω—ã

‚úÖ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:**
- **–û—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã** (b2b_orders vs orders) - –ª–µ–≥—á–µ —É–ø—Ä–∞–≤–ª—è—Ç—å
- **–û–±—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã** (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è PDF, email) - DRY –ø—Ä–∏–Ω—Ü–∏–ø
- **–†–∞–∑–¥–µ–ª—å–Ω–∞—è –∞–¥–º–∏–Ω–∫–∞** (/admin/b2b-orders vs /admin/orders) - —Ä–∞–∑–Ω—ã–π UX
- **API versioning** (/api/v1/b2b/) - –¥–ª—è –±—É–¥—É—â–µ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

---

## 10. –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –≠—Ç–∞–ø 1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–ù–µ–¥–µ–ª—è 1)
- [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è B2B —Ç–∞–±–ª–∏—Ü
- [ ] –î–æ–±–∞–≤–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏
- [ ] –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

### –≠—Ç–∞–ø 2: Backend API (–ù–µ–¥–µ–ª—è 2)
- [ ] –°–µ—Ä–≤–∏—Å b2b-order.ts
- [ ] –°–µ—Ä–≤–∏—Å invoice.ts (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—á–µ—Ç–æ–≤)
- [ ] –°–µ—Ä–≤–∏—Å b2b-discount.ts
- [ ] API endpoints
- [ ] –¢–µ—Å—Ç—ã

### –≠—Ç–∞–ø 3: Frontend (–ù–µ–¥–µ–ª—è 3-4)
- [ ] –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–∞–∫–µ—Ç–∞
- [ ] –§–æ—Ä–º–∞ B2B –∑–∞–∫–∞–∑–∞
- [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—Ö–∞
- [ ] Email —à–∞–±–ª–æ–Ω—ã

### –≠—Ç–∞–ø 4: Admin –ø–∞–Ω–µ–ª—å (–ù–µ–¥–µ–ª—è 5)
- [ ] –°–ø–∏—Å–æ–∫ B2B –∑–∞–∫–∞–∑–æ–≤
- [ ] –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
- [ ] –û–ø–µ—Ä–∞—Ü–∏–∏ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –æ—Ç–ø—Ä–∞–≤–∫–∞)
- [ ] –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

### –≠—Ç–∞–ø 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–ù–µ–¥–µ–ª—è 6)
- [ ] Unit —Ç–µ—Å—Ç—ã
- [ ] Integration —Ç–µ—Å—Ç—ã
- [ ] E2E —Ç–µ—Å—Ç—ã
- [ ] Load —Ç–µ—Å—Ç—ã

---

**–î–æ–∫—É–º–µ–Ω—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ B2B —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞! üöÄ**
